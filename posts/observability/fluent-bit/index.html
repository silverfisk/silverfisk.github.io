<!doctype html><html lang=en><head><title>Fluent Bit: Isolating pod logs in a multitenant EKS cluster · linux-konsult.com
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Tom"><meta name=description content="Fluent Bit: Isolating pod logs in a multitenant EKS cluster"><meta name=keywords content="blog,devops,sustainability,esp8266,prometheus,grafana"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fluent Bit: Isolating pod logs in a multitenant EKS cluster"><meta name=twitter:description content="Fluent Bit: Isolating pod logs in a multitenant EKS cluster"><meta property="og:url" content="https://linux-konsult.com/posts/observability/fluent-bit/"><meta property="og:site_name" content="linux-konsult.com"><meta property="og:title" content="Fluent Bit: Isolating pod logs in a multitenant EKS cluster"><meta property="og:description" content="Fluent Bit: Isolating pod logs in a multitenant EKS cluster"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-07T22:00:07+02:00"><meta property="article:modified_time" content="2022-12-07T22:00:07+02:00"><meta property="article:tag" content="Observability"><meta property="article:tag" content="Fluent Bit"><meta property="article:tag" content="EKS"><meta property="article:tag" content="K8s"><meta property="article:tag" content="Logging"><link rel=canonical href=https://linux-konsult.com/posts/observability/fluent-bit/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.bb7a78bfb4e57aba6e78691ce9ad3fef35238fff2f55149e48bb3c43becd260c.css integrity="sha256-u3p4v7TlerpueGkc6a0/7zUjj/8vVRSeSLs8Q77NJgw=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-light"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://linux-konsult.com/>linux-konsult.com
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts>Blog</a></li><li class=navigation-item><a class=navigation-link href=/categories>Topics</a></li><li class=navigation-item><a class=navigation-link href=/links>Links</a></li><li class=navigation-item><a class=navigation-link href=http://whoami.linux-konsult.com>Resume</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://linux-konsult.com/posts/observability/fluent-bit/>Fluent Bit: Isolating pod logs in a multitenant EKS cluster</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2022-12-07T22:00:07+02:00>December 7, 2022
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
4-minute read</span></div><div class=categories><i class="fa-solid fa-folder" aria-hidden=true></i>
<a href=/categories/observability/>Observability</a></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/observability/>Observability</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/fluent-bit/>Fluent Bit</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/eks/>EKS</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/k8s/>K8s</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/logging/>Logging</a></span></div></div></header><div class=post-content><h1 id=overview>Overview
<a class=heading-link href=#overview><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><hr><p>In this post, we discuss how to isolate log access in a multitenant AWS EKS cluster between tenants. This solution is intended for those who need to give customer team members access to their own microservice log output without replicating the log storage out to other logging solutions or out of the AWS account to minimize the risk of data leakage.</p><h2 id=situation>Situation
<a class=heading-link href=#situation><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We have a multi-tenant EKS Kubernetes cluster that is used as an internal development platform. Development teams use the platform to deploy their microservices. While the developers do not have access to the AWS account hosting the cluster, they do need access to their own log files. These log files are stored in AWS CloudWatch Logs in the EKS AWS account, to which the developers do not have access. However, the customer team does have their own AWS account.
<img src=/img/fluent-bit.png alt=FluentBit>
By default, the cluster uses a Fluent Bit daemonset to forward all pod logs to the same Log Group in AWS CloudWatch Logs. This configuration allows the customer team to access their logs, even though the developers cannot log in to the EKS AWS account.</p><h2 id=task>Task
<a class=heading-link href=#task><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The goal is to give customer team members access to their own microservice log output, without replicating the log storage out to other logging solutions, and/or out of the AWS account to minimize the risk of data leakage. It is also important that other teams using the same multitenant cluster cannot access each other&rsquo;s logs. System pods and similar should log to a common Log Group so the Platform Engineering team has easy access to logs not belonging to development teams. This also ensures separation of concerns and least privilege, so that platform engineers cannot read application output unless given access to those log groups.</p><h2 id=action>Action
<a class=heading-link href=#action><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><strong>Fluent Bit Overview</strong></p><p>A Fluent Bit daemonset is configured to ingest logs on each node. Each log source is defined as an [INPUT] section in the fluent configuration, and every event always has to consist of a timestamp and a message, and then it is tagged as it comes in to its input.</p><p>If any processing of such an event needs to be done, this is done with a [FILTER] block. This can be used to reshape, drop, or even annotate the event with metadata.</p><p>There are other features such as parsers, storage, and routers, but they will not be mentioned here. The last part to configure is an [OUTPUT].</p><h4 id=configuration>Configuration
<a class=heading-link href=#configuration><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>Here is a standard input configuration for Fluent Bit. It ingests container logs and gives the events the kube.* tag:</p><pre tabindex=0><code>[INPUT]
    Name                tail
    Tag                 kube.*
    Path                /var/log/containers/*.log
    DB                  /var/fluent-bit/state/flb_kube.db
    Parser              docker
    Docker_Mode         On
    Mem_Buf_Limit       5MB
    Skip_Long_Lines     On
    Refresh_Interval    10
</code></pre><p>Next step is crucial, letting the Fluent Bit <a href=https://docs.fluentbit.io/manual/pipeline/filters/kubernetes class=external-link target=_blank rel=noopener>kubernetes</a> filter query the Kubernetes control plane to enrich each event with metadata:</p><pre tabindex=0><code>[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc.cluster.local:443
    Merge_Log           On
    Merge_Log_Key       data
    K8S-Logging.Parser  On
    K8S-Logging.Exclude On
</code></pre><p>To isolate logs and limit access to information based on least privilege, we use the cloudwatch_logs output and the log_group_template key to define a unique log group based on namespace and other labels. For our purposes, this combination of labels is only relevant for customer pods. All other logs will fall back to the log_group_name and be stored in the cluster application log.</p><pre tabindex=0><code>[OUTPUT]
    Name                cloudwatch_logs
    Match               kube.*
    region              ${AWS_REGION}
    log_group_name      /aws/containerinsights/${CLUSTER_NAME}/application
    log_group_template  application-logs/${CLUSTER_NAME}.$kubernetes[&#39;namespace_name&#39;].$kubernetes[&#39;labels&#39;][&#39;app.kubernetes.io/name&#39;]
    log_stream_prefix   ${HOST_NAME}-
    auto_create_group   true
    extra_user_agent    container-insights
    log_retention_days  90
</code></pre><p><strong>But there&rsquo;s one last catch!</strong> If you read the documentation for log_group_template carefully, you will see a warning is logged each time a fallback is made. To avoid unwanted warning messages in your logs, make sure to configure the Log_Level to only log Fluent Bit errors:</p><pre tabindex=0><code>[SERVICE]
    Flush                     5
    Log_Level                 error
</code></pre><h2 id=result>Result
<a class=heading-link href=#result><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p><img src=/img/fluent-bit2.png alt=FluentBit>
By querying the Kubernetes control plane to enrich log messages and diverting them to the correct log storage, we can lower logging costs and reduce the risk of data leakage. Additionally, we avoid any potential issues with a single source of truth, and keep our environmental and cost footprint to a minimum by not duplicating log data.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2025
Tom
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>