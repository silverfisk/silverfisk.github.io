<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Tom"><meta name=description content="https://linux-konsult.com"><meta name=keywords content="blog,devops,sustainability,esp8266,prometheus,grafana"><meta property="og:site_name" content="linux-konsult.com"><meta property="og:title" content="
  Fluent Bit: Isolating pod logs in a multitenant EKS cluster - linux-konsult.com
"><meta property="og:description" content="Fluent Bit: Isolating pod logs in a multitenant EKS cluster"><meta property="og:type" content="website"><meta property="og:url" content="https://linux-konsult.com/posts/observability/fluent-bit/"><meta property="og:image" content="https://linux-konsult.com"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://linux-konsult.com/posts/observability/fluent-bit/"><meta name=twitter:image content="https://linux-konsult.com"><base href=https://linux-konsult.com/posts/observability/fluent-bit/><title>Fluent Bit: Isolating pod logs in a multitenant EKS cluster - linux-konsult.com</title><link rel=canonical href=https://linux-konsult.com/posts/observability/fluent-bit/><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.2.0/css/all.css integrity=sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700"><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://linux-konsult.com/index.xml type=application/rss+xml title=linux-konsult.com><link href=https://linux-konsult.com/index.xml rel=feed type=application/rss+xml title=linux-konsult.com><meta name=generator content="Hugo 0.108.0"></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>linux-konsult.com</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-center"><a class=navigation-link href=https://linux-konsult.com/posts>Blog</a></li><li class="navigation-item align-center"><a class=navigation-link href=https://linux-konsult.com/categories>Topics</a></li><li class="navigation-item align-center"><a class=navigation-link href=https://linux-konsult.com/links>Links</a></li><li class="navigation-item align-center"><a class=navigation-link href=https://whoami.linux-konsult.com>Resume</a></li></ul></label></section></nav><div class=content><section class="container post"><article><header><h1 class=title>Fluent Bit: Isolating pod logs in a multitenant EKS cluster</h1><h2 class=date>December 7, 2022</h2></header><h1 id=overview>Overview</h1><hr><p>In this post, we discuss how to isolate log access in a multitenant AWS EKS cluster between tenants. This solution is intended for those who need to give customer team members access to their own microservice log output without replicating the log storage out to other logging solutions or out of the AWS account to minimize the risk of data leakage.</p><h2 id=situation>Situation</h2><p>We have a multi-tenant EKS Kubernetes cluster that is used as an internal development platform. Development teams use the platform to deploy their microservices. While the developers do not have access to the AWS account hosting the cluster, they do need access to their own log files. These log files are stored in AWS CloudWatch Logs in the EKS AWS account, to which the developers do not have access. However, the customer team does have their own AWS account.<div class=portfolio><div class=portfolio-inner><div class=portfolio-image><img src=/img/fluent-bit.png alt=FluentBit></div><div class=portfolio-content><p>By default, the cluster uses a Fluent Bit daemonset to forward all pod logs to the same Log Group in AWS CloudWatch Logs. This configuration allows the customer team to access their logs, even though the developers cannot log in to the EKS AWS account.</p></div></div></div></p><h2 id=task>Task</h2><p>The goal is to give customer team members access to their own microservice log output, without replicating the log storage out to other logging solutions, and/or out of the AWS account to minimize the risk of data leakage. It is also important that other teams using the same multitenant cluster cannot access each other&rsquo;s logs. System pods and similar should log to a common Log Group so the Platform Engineering team has easy access to logs not belonging to development teams. This also ensures separation of concerns and least privilege, so that platform engineers cannot read application output unless given access to those log groups.</p><h2 id=action>Action</h2><p><strong>Fluent Bit Overview</strong></p><p>A Fluent Bit daemonset is configured to ingest logs on each node. Each log source is defined as an [INPUT] section in the fluent configuration, and every event always has to consist of a timestamp and a message, and then it is tagged as it comes in to its input.</p><p>If any processing of such an event needs to be done, this is done with a [FILTER] block. This can be used to reshape, drop, or even annotate the event with metadata.</p><p>There are other features such as parsers, storage, and routers, but they will not be mentioned here. The last part to configure is an [OUTPUT].</p><h4 id=configuration>Configuration</h4><p>Here is a standard input configuration for Fluent Bit. It ingests container logs and gives the events the kube.* tag:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[INPUT]
</span></span><span class=line><span class=cl>    Name                tail
</span></span><span class=line><span class=cl>    Tag                 kube.*
</span></span><span class=line><span class=cl>    Path                /var/log/containers/*.log
</span></span><span class=line><span class=cl>    DB                  /var/fluent-bit/state/flb_kube.db
</span></span><span class=line><span class=cl>    Parser              docker
</span></span><span class=line><span class=cl>    Docker_Mode         On
</span></span><span class=line><span class=cl>    Mem_Buf_Limit       5MB
</span></span><span class=line><span class=cl>    Skip_Long_Lines     On
</span></span><span class=line><span class=cl>    Refresh_Interval    10
</span></span></code></pre></div><p>Next step is crucial, letting the Fluent Bit <a href=https://docs.fluentbit.io/manual/pipeline/filters/kubernetes>kubernetes</a> filter query the Kubernetes control plane to enrich each event with metadata:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[FILTER]
</span></span><span class=line><span class=cl>    Name                kubernetes
</span></span><span class=line><span class=cl>    Match               kube.*
</span></span><span class=line><span class=cl>    Kube_URL            https://kubernetes.default.svc.cluster.local:443
</span></span><span class=line><span class=cl>    Merge_Log           On
</span></span><span class=line><span class=cl>    Merge_Log_Key       data
</span></span><span class=line><span class=cl>    K8S-Logging.Parser  On
</span></span><span class=line><span class=cl>    K8S-Logging.Exclude On
</span></span></code></pre></div><p>To isolate logs and limit access to information based on least privilege, we use the cloudwatch_logs output and the log_group_template key to define a unique log group based on namespace and other labels. For our purposes, this combination of labels is only relevant for customer pods. All other logs will fall back to the log_group_name and be stored in the cluster application log.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[OUTPUT]
</span></span><span class=line><span class=cl>    Name                cloudwatch_logs
</span></span><span class=line><span class=cl>    Match               kube.*
</span></span><span class=line><span class=cl>    region              ${AWS_REGION}
</span></span><span class=line><span class=cl>    log_group_name      /aws/containerinsights/${CLUSTER_NAME}/application
</span></span><span class=line><span class=cl>    log_group_template  application-logs/${CLUSTER_NAME}.$kubernetes[&#39;namespace_name&#39;].$kubernetes[&#39;labels&#39;][&#39;app.kubernetes.io/name&#39;]
</span></span><span class=line><span class=cl>    log_stream_prefix   ${HOST_NAME}-
</span></span><span class=line><span class=cl>    auto_create_group   true
</span></span><span class=line><span class=cl>    extra_user_agent    container-insights
</span></span><span class=line><span class=cl>    log_retention_days  90
</span></span></code></pre></div><p><strong>But there&rsquo;s one last catch!</strong> If you read the documentation for log_group_template carefully, you will see a warning is logged each time a fallback is made. To avoid unwanted warning messages in your logs, make sure to configure the Log_Level to only log Fluent Bit errors:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[SERVICE]
</span></span><span class=line><span class=cl>    Flush                     5
</span></span><span class=line><span class=cl>    Log_Level                 error
</span></span></code></pre></div><h2 id=result>Result</h2><div class=portfolio><div class=portfolio-inner><div class=portfolio-image><img src=/img/fluent-bit2.png alt=FluentBit></div><div class=portfolio-content><p>By querying the Kubernetes control plane to enrich log messages and diverting them to the correct log storage, we can lower logging costs and reduce the risk of data leakage. Additionally, we avoid any potential issues with a single source of truth, and keep our environmental and cost footprint to a minimum by not duplicating log data.</p></div></div></div></article><br></section></div><footer class=footer><section class=container><div class="sns-shares sp-sns-shares"><a class="sns-share linkedIn-share" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2flinux-konsult.com%2fposts%2fobservability%2ffluent-bit%2f"><i class="fab fa-linkedin"></i></a></div></section></footer><div class=fixed-bar><section class=container><p id=privateTriggerText>Contact details <a id=privateTrigger>Click!</a></p><div class="sns-shares pc-sns-shares"><a class="sns-share linkedIn-share" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2flinux-konsult.com%2fposts%2fobservability%2ffluent-bit%2f"><i class="fab fa-linkedin"></i></a></div></section></div></main><script src=/js/app.js></script>
<script>(function(e){e(function(){e("#privateTrigger").on("click",function(){e(".private").slideToggle(),e("#privateTriggerText").text("tom@linux-konsult.com")})})})(jQuery)</script></body></html>