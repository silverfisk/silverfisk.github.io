<!doctype html><html lang=en><head><title>Let karpenters just-in-time scheduler manage disk pressure · linux-konsult.com
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Tom"><meta name=description content="Kapacity planning in kubernetes"><meta name=keywords content="blog,devops,sustainability,esp8266,prometheus,grafana"><meta name=twitter:card content="summary"><meta name=twitter:title content="Let karpenters just-in-time scheduler manage disk pressure"><meta name=twitter:description content="Kapacity planning in kubernetes"><meta property="og:url" content="https://linux-konsult.com/posts/k8s/karpenter/"><meta property="og:site_name" content="linux-konsult.com"><meta property="og:title" content="Let karpenters just-in-time scheduler manage disk pressure"><meta property="og:description" content="Kapacity planning in kubernetes"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-27T14:30:00+02:00"><meta property="article:modified_time" content="2022-10-27T14:30:00+02:00"><meta property="article:tag" content="K8s"><meta property="article:tag" content="GitLab"><meta property="article:tag" content="GitOps"><meta property="article:tag" content="Karpenter"><link rel=canonical href=https://linux-konsult.com/posts/k8s/karpenter/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.bb7a78bfb4e57aba6e78691ce9ad3fef35238fff2f55149e48bb3c43becd260c.css integrity="sha256-u3p4v7TlerpueGkc6a0/7zUjj/8vVRSeSLs8Q77NJgw=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-light"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://linux-konsult.com/>linux-konsult.com
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts>Blog</a></li><li class=navigation-item><a class=navigation-link href=/categories>Topics</a></li><li class=navigation-item><a class=navigation-link href=/links>Links</a></li><li class=navigation-item><a class=navigation-link href=http://whoami.linux-konsult.com>Resume</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://linux-konsult.com/posts/k8s/karpenter/>Let karpenters just-in-time scheduler manage disk pressure</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2022-10-27T14:30:00+02:00>October 27, 2022
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
3-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/k8s/>K8s</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/gitlab/>GitLab</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/gitops/>GitOps</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/karpenter/>Karpenter</a></span></div></div></header><div class=post-content><h2 id=overview>Overview
<a class=heading-link href=#overview><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><hr><p>Capacity planning in Kubernetes can be challenging.
Karpenter is useful for automatically rightscaling and rightsizing Kubernetes nodes in an EKS cluster, but it usually only considers CPU and memory usage. We experienced difficulties troubleshooting this issue because the node storage was not full at the time we checked it. The disk usage would spike to almost capacity (98-99%) during the execution of GitLab CI jobs, then decrease after the job was completed. This made it difficult to identify the cause of the issue.</p><p>To address this issue, we used the<code>Provisioner</code> kind to configure the just-in-time node scheduler to place bids for new (or larger) spot instance nodes. In addition to providing a better ROI on the cluster, this approach also helps to improve Cloud Sustainability targets, such as <a href=https://docs.aws.amazon.com/wellarchitected/latest/sustainability-pillar/sus_sus_hardware_a2.html class=external-link target=_blank rel=noopener>SUS05-BP01</a>, by using the minimum amount of hardware needed to meet your needs if you follow the new <a href=https://docs.aws.amazon.com/wellarchitected/latest/sustainability-pillar/sustainability-pillar.html class=external-link target=_blank rel=noopener>AWS Well Architected Sustaninability Pillar</a>.</p><p>This lets karpenter configure nodes to automatically perform garbage collection, and taint itself to avoid further pod scheduling. As a last resort it will kill greedy CI jobs to keep the cluster as a whole more consistent, performant and stable.</p><p><img src=/img/k8s_rightsizing.png alt="K8s Rightsizing"></p><h3 id=karpenter-kubelet-configuration>Karpenter kubelet Configuration
<a class=heading-link href=#karpenter-kubelet-configuration><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><hr><p>One way to address the issue of full disks on Kubernetes nodes is to use Karpenter to set a kubeletConfiguration. This allows the <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/ class=external-link target=_blank rel=noopener>kubelet</a> to start the <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/node-pressure-eviction/ class=external-link target=_blank rel=noopener>Node-pressure Eviction</a> process, which proactively terminates pods to reclaim resources on the affected node.</p><p>While this approach may cause some GitLab CI jobs to fail when node disks are full, it also reduces the impact on other jobs by limiting the &ldquo;blast radius&rdquo; of a job that fills up disks. In general, it can help to keep the cluster more consistent, performant, and stable.</p><p>Check if the cluster already has a kubeletConfiguration:</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>localhost<span style=color:#ff7b72;font-weight:700>]</span>$ kubectl get provisioners.karpenter.sh default  -oyaml | yq .spec.kubeletConfiguration
</span></span></code></pre></div><hr><h2 id=configuration-knobs>Configuration knobs
<a class=heading-link href=#configuration-knobs><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Setting these values may cause some pods and their CI jobs to be killed as a last resort. In our setup, the most common issue with full disks was CI jobs executing in very large container images which caused the image storage to fill up. It is important to investigate whether adding more node disk space would be a more effective preventive solution, as this is more of a way to handle node scaling if the disks fill up despite preventive actions already being taken.</p><p>Before any jobs are evicted due to DiskPressure, the kubelet will attempt to reclaim resources by culling dead pods and images.</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>karpenter.sh/v1alpha5</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Provisioner</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>default</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#a5d6ff>&lt;...&gt;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>kubeletConfiguration</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>ephemeral-storage</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>15Gi</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>kubeReserved</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>cpu</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>200m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>memory</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>100Mi</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>ephemeral-storage</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>3Gi</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>evictionHard</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>memory.available</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5</span><span style=color:#a5d6ff>%</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>nodefs.available</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>10</span><span style=color:#a5d6ff>%</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>nodefs.inodesFree</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>10</span><span style=color:#a5d6ff>%</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>evictionSoft</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>memory.available</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>500Mi</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>nodefs.available</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>15</span><span style=color:#a5d6ff>%</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>nodefs.inodesFree</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>15</span><span style=color:#a5d6ff>%</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>evictionSoftGracePeriod</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>memory.available</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>3m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>nodefs.available</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1m30s</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>nodefs.inodesFree</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>2m</span><span style=color:#6e7681>
</span></span></span></code></pre></div></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2025
Tom
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>